<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Create Pet Memorial | Lap of Love</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="container">
            <div class="nav-content">
                <a href="/" class="logo">Lap of Love</a>
                <ul class="nav-menu">
                    <li>
                        <a href="#services">Services</a>
                        <div class="dropdown">
                            <div class="dropdown-section">
                                <div class="dropdown-title">In-Home Services</div>
                                <a href="#euthanasia">In-Home Euthanasia</a>
                                <a href="#quality-life">Quality of Life Consultation</a>
                                <a href="#telemedicine">Telemedicine</a>
                                <a href="#hospice">Pet Hospice Care</a>
                            </div>
                            <div class="dropdown-section">
                                <div class="dropdown-title">Aftercare</div>
                                <a href="#cremation">Pet Cremation</a>
                                <a href="#memorials">Pet Memorials</a>
                                <a href="#keepsakes">Memorial Keepsakes</a>
                            </div>
                        </div>
                    </li>
                    <li>
                        <a href="#resources">Resources</a>
                        <div class="dropdown">
                            <a href="#grief-support">Grief Support</a>
                            <a href="#rainbow-bridge">Rainbow Bridge</a>
                            <a href="#pet-loss">Pet Loss Resources</a>
                            <a href="#blog">Blog & Articles</a>
                            <a href="#faq">FAQ</a>
                            <a href="#costs">Service Costs</a>
                        </div>
                    </li>
                    <li>
                        <a href="#quality">Quality of Life</a>
                        <div class="dropdown">
                            <a href="#scale">Quality of Life Scale</a>
                            <a href="#assessment">Pet Assessment</a>
                            <a href="#pain-management">Pain Management</a>
                            <a href="#senior-care">Senior Pet Care</a>
                            <a href="#when-time">When It's Time</a>
                        </div>
                    </li>
                    <li>
                        <a href="#community">Community</a>
                        <div class="dropdown">
                            <a href="/">Pet Memorials</a>
                            <a href="/create">Create Memorial</a>
                            <a href="#stories">Pet Stories</a>
                            <a href="#support-groups">Support Groups</a>
                            <a href="#events">Community Events</a>
                            <a href="#newsletter">Newsletter</a>
                        </div>
                    </li>
                    <li>
                        <a href="#about">About Us</a>
                        <div class="dropdown">
                            <a href="#our-story">Our Story</a>
                            <a href="#team">Our Team</a>
                            <a href="#mission">Mission & Values</a>
                            <a href="#locations">Service Areas</a>
                            <a href="#reviews">Reviews</a>
                            <a href="#press">Press & Media</a>
                        </div>
                    </li>
                </ul>
                <div class="nav-buttons">
                    <a href="#schedule" class="nav-btn nav-btn-outline">Schedule</a>
                    <a href="#join" class="nav-btn nav-btn-outline">Join Our Team</a>
                    <a href="#find" class="nav-btn nav-btn-purple">Find a Vet</a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Create Memorial Hero -->
    <section class="hero-section">
        <div class="container">
            <div class="hero-content">
                <h1 class="hero-title">Create a Pet Memorial</h1>
                <p class="hero-subtitle">
                    Create a lasting tribute to honor your beloved companion.<br>
                    Share their story, celebrate their life, and keep their memory alive forever.
                </p>
                <a href="/" class="hero-cta-btn secondary">← Back to Pet Memorials</a>
            </div>
        </div>
    </section>

    <!-- Create Memorial Section -->
    <section class="memorials-section">
        <div class="container">
            <div class="create-section">
                <div class="create-header" style="padding: 20px 40px;">
                    <h2 style="font-size: 24px; margin-bottom: 20px;">Memorial Details</h2>
                </div>

                <form id="memorialForm" class="create-form" enctype="multipart/form-data">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="petName" class="form-label">Pet's Name *</label>
                            <input type="text" id="petName" name="petName" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label for="ownerName" class="form-label">Your Name *</label>
                            <input type="text" id="ownerName" name="ownerName" class="form-input" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="birthDate" class="form-label">Birth Date</label>
                            <input type="date" id="birthDate" name="birthDate" class="form-input">
                        </div>
                        <div class="form-group">
                            <label for="deathDate" class="form-label">Passed Away</label>
                            <input type="date" id="deathDate" name="deathDate" class="form-input">
                        </div>
                    </div>

                    <div class="form-group full-width">
                        <label for="story" class="form-label">Memorial Story *</label>
                        <textarea id="story" name="story" class="form-textarea" placeholder="Share your favorite memories, their personality, and what made them special..." required style="min-height: 120px;"></textarea>
                    </div>

                    <div class="form-group full-width">
                        <label class="form-label">Pet Photos</label>
                        
                        <!-- 图片选择方式 -->
                        <div style="margin-bottom: 15px;">
                            <label style="display: flex; align-items: center; margin-bottom: 10px;">
                                <input type="radio" name="photoOption" value="upload" style="margin-right: 8px;" checked onchange="togglePhotoOption()">
                                上传自己的照片
                            </label>
                            <label style="display: flex; align-items: center;">
                                <input type="radio" name="photoOption" value="random" style="margin-right: 8px;" onchange="togglePhotoOption()">
                                使用我们精选的照片（适用高速CDN加持）
                            </label>
                        </div>

                        <!-- 文件上传区域 -->
                        <div id="uploadArea" class="file-upload" onclick="document.getElementById('photos').click()">
                            <input type="file" id="photos" name="photos" accept="image/*" multiple>
                            <div class="file-upload-text">Click to select photos or drag and drop</div>
                            <div class="file-upload-hint">Upload multiple photos to create a gallery</div>
                        </div>

                        <!-- 随机图片预览区域 -->
                        <div id="randomArea" style="display: none; padding: 20px; border: 2px dashed #ddd; border-radius: 8px; text-align: center;">
                            <p style="margin-bottom: 15px; color: #666;">将自动为您的纪念册分配一张高质量的宠物照片</p>
                            <button type="button" onclick="previewRandomImage()" style="background: #8B5CF6; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">预览随机图片</button>
                            <div id="randomPreview" style="margin-top: 15px;"></div>
                        </div>

                        <div id="photoPreview" class="photo-gallery" style="margin-top: 20px;"></div>
                    </div>

                    <!-- Personal Information Section -->
                    <div class="form-section-title" style="margin-top: 40px; margin-bottom: 20px;">
                        <h3 style="font-size: 20px; font-weight: 600; color: #1f2937;">Personal Information</h3>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="firstName" class="form-label">First Name*</label>
                            <input type="text" id="firstName" name="firstName" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label for="lastName" class="form-label">Last Name</label>
                            <input type="text" id="lastName" name="lastName" class="form-input">
                        </div>
                    </div>

                    <div class="form-group full-width">
                        <label for="email" class="form-label">Email Address*</label>
                        <input type="email" id="email" name="email" class="form-input" required>
                    </div>

                    <div class="form-group full-width">
                        <label for="memoryMessage" class="form-label">Leave a message in memory of your pet*</label>
                        <textarea id="memoryMessage" name="memoryMessage" class="form-textarea" placeholder="Share a special memory or message..." required style="min-height: 120px;"></textarea>
                    </div>

                    <div class="form-group full-width" style="margin-bottom: 20px;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="checkbox" id="displayName" name="displayName" style="width: 20px; height: 20px; margin-right: 10px; cursor: pointer;" checked>
                            <span style="font-size: 14px; color: #4b5563;">Would you like your name displayed with your memorial?</span>
                        </label>
                    </div>

                    <!-- Share Memorial Section -->
                    <div class="form-section-title" style="margin-top: 30px; margin-bottom: 15px;">
                        <h3 style="font-size: 18px; font-weight: 600; color: #1f2937;">Would you like to share your memorial with friends or family?</h3>
                    </div>

                    <div class="form-group full-width">
                        <input type="text" id="shareEmails" name="shareEmails" class="form-input" placeholder="Email addresses of friends to share your memorial with">
                    </div>

                    <button type="submit" class="submit-btn" style="width: 100%; padding: 15px; background: #6366f1; font-size: 16px;">Create Memorial</button>
                </form>
            </div>
        </div>
    </section>

    <!-- Thank You Modal -->
    <div id="thankYouModal" class="thank-you-modal">
        <div class="thank-you-content">
            <button class="thank-you-close" onclick="closeThankYouModal()">×</button>
            <div class="thank-you-icon">🕯️</div>
            <h2 class="thank-you-title">Thank you for submitting your memorial</h2>
            <p class="thank-you-message">
                We will post it within 5 business days and you will receive an email letting you know your angel's memorial is ready to view.
            </p>
            <button class="thank-you-btn" onclick="closeThankYouModal()">确定</button>
        </div>
    </div>

    <style>
        .photo-preview-item {
            position: relative;
            display: inline-block;
        }
        .photo-preview-item img {
            width: 150px;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid #ddd;
        }
        .photo-remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        .photo-remove-btn:hover {
            background: rgb(220, 38, 38);
            transform: scale(1.1);
        }
        .photo-counter {
            margin-top: 10px;
            color: #666;
            font-size: 14px;
        }
    </style>

    <script>
        const form = document.getElementById('memorialForm');
        const photosInput = document.getElementById('photos');
        const photoPreview = document.getElementById('photoPreview');
        
        // 存储已选择的文件
        let selectedFiles = [];
        const MAX_PHOTOS = 6;

        // 切换图片选择方式
        function togglePhotoOption() {
            const photoOption = document.querySelector('input[name="photoOption"]:checked').value;
            const uploadArea = document.getElementById('uploadArea');
            const randomArea = document.getElementById('randomArea');
            
            if (photoOption === 'upload') {
                uploadArea.style.display = 'block';
                randomArea.style.display = 'none';
                updatePhotoPreview();
            } else {
                uploadArea.style.display = 'none';
                randomArea.style.display = 'block';
                photoPreview.innerHTML = '';
                selectedFiles = [];
                photosInput.value = '';
            }
        }

        // 预览随机图片
        function previewRandomImage() {
            const randomPreview = document.getElementById('randomPreview');
            // 从CDN图片池中随机选择一张
            const randomImages = [
                'https://images.unsplash.com/photo-1548199973-03cce0bbc87b?w=400&h=400&fit=crop&crop=face',
                'https://images.unsplash.com/photo-1514888286974-6c03e2ca1dba?w=400&h=400&fit=crop&crop=face',
                'https://images.unsplash.com/photo-1601758228041-f3b2795255f1?w=400&h=400&fit=crop&crop=face',
                'https://images.unsplash.com/photo-1574158622682-e40e69881006?w=400&h=400&fit=crop&crop=face',
                'https://images.unsplash.com/photo-1537151608828-ea2b11777ee8?w=400&h=400&fit=crop&crop=face'
            ];
            const randomImage = randomImages[Math.floor(Math.random() * randomImages.length)];
            
            randomPreview.innerHTML = `
                <img src="${randomImage}" style="width: 200px; height: 200px; object-fit: cover; border-radius: 8px; border: 2px solid #ddd;">
                <p style="margin-top: 10px; color: #666; font-size: 14px;">这是一张示例图片，实际图片将在提交时随机分配</p>
            `;
        }

        // 更新照片预览
        function updatePhotoPreview() {
            photoPreview.innerHTML = '';
            
            selectedFiles.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const container = document.createElement('div');
                    container.className = 'photo-preview-item';
                    
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'photo-remove-btn';
                    removeBtn.innerHTML = '×';
                    removeBtn.type = 'button';
                    removeBtn.onclick = function() {
                        removePhoto(index);
                    };
                    
                    container.appendChild(img);
                    container.appendChild(removeBtn);
                    photoPreview.appendChild(container);
                };
                reader.readAsDataURL(file);
            });
            
            // 显示照片计数
            const counter = document.createElement('div');
            counter.className = 'photo-counter';
            counter.textContent = `已选择 ${selectedFiles.length}/${MAX_PHOTOS} 张照片`;
            if (selectedFiles.length >= MAX_PHOTOS) {
                counter.style.color = '#dc2626';
                counter.textContent += ' (已达上限)';
            }
            photoPreview.appendChild(counter);
        }

        // 删除照片
        function removePhoto(index) {
            selectedFiles.splice(index, 1);
            updatePhotoPreview();
            
            // 更新input的files（需要重新创建DataTransfer）
            const dt = new DataTransfer();
            selectedFiles.forEach(file => dt.items.add(file));
            photosInput.files = dt.files;
        }

        photosInput.addEventListener('change', function(e) {
            const newFiles = Array.from(e.target.files);
            
            // 计算还能添加多少张照片
            const remainingSlots = MAX_PHOTOS - selectedFiles.length;
            
            if (remainingSlots <= 0) {
                alert(`最多只能上传 ${MAX_PHOTOS} 张照片！`);
                photosInput.value = '';
                return;
            }
            
            // 只添加允许数量的照片
            const filesToAdd = newFiles.slice(0, remainingSlots).filter(file => file.type.startsWith('image/'));
            
            if (filesToAdd.length < newFiles.length) {
                alert(`最多只能上传 ${MAX_PHOTOS} 张照片，已为您选择前 ${filesToAdd.length} 张。`);
            }
            
            // 添加新文件到已选择列表
            selectedFiles = [...selectedFiles, ...filesToAdd];
            
            // 更新预览
            updatePhotoPreview();
            
            // 清空input以便下次可以选择相同的文件
            photosInput.value = '';
        });

        form.addEventListener('submit', async function(e) {
            e.preventDefault();

            const submitBtn = form.querySelector('button[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Creating Memorial...';
            submitBtn.disabled = true;

            try {
                const formData = new FormData(form);
                
                // 检查是否使用随机图片
                const photoOption = document.querySelector('input[name="photoOption"]:checked').value;
                if (photoOption === 'random') {
                    formData.append('useRandomImage', 'true');
                } else if (photoOption === 'upload' && selectedFiles.length > 0) {
                    // 清空默认的photos字段，使用我们管理的selectedFiles
                    formData.delete('photos');
                    selectedFiles.forEach(file => {
                        formData.append('photos', file);
                    });
                }

                const response = await fetch('/api/memorial', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    showThankYouModal();
                } else {
                    throw new Error(result.message || 'Failed to create memorial');
                }
            } catch (error) {
                console.error('Failed to create memorial:', error);
                alert('Failed to create memorial. Please try again.');
            } finally {
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        });

        // Drag and drop functionality
        const fileUpload = document.querySelector('.file-upload');

        fileUpload.addEventListener('dragover', function(e) {
            e.preventDefault();
            this.style.borderColor = '#6366f1';
            this.style.backgroundColor = '#f0f9ff';
        });

        fileUpload.addEventListener('dragleave', function(e) {
            e.preventDefault();
            this.style.borderColor = '#d1d5db';
            this.style.backgroundColor = '#f9fafb';
        });

        fileUpload.addEventListener('drop', function(e) {
            e.preventDefault();
            this.style.borderColor = '#d1d5db';
            this.style.backgroundColor = '#f9fafb';

            const files = Array.from(e.dataTransfer.files);
            const remainingSlots = MAX_PHOTOS - selectedFiles.length;
            
            if (remainingSlots <= 0) {
                alert(`最多只能上传 ${MAX_PHOTOS} 张照片！`);
                return;
            }
            
            const filesToAdd = files.slice(0, remainingSlots).filter(file => file.type.startsWith('image/'));
            
            if (filesToAdd.length < files.length) {
                alert(`最多只能上传 ${MAX_PHOTOS} 张照片，已为您添加 ${filesToAdd.length} 张。`);
            }
            
            selectedFiles = [...selectedFiles, ...filesToAdd];
            updatePhotoPreview();
        });

        // Thank You Modal Functions
        function showThankYouModal() {
            document.getElementById('thankYouModal').classList.add('show');
        }

        function closeThankYouModal() {
            document.getElementById('thankYouModal').classList.remove('show');
            window.location.href = '/';
        }

        // Close modal when clicking outside
        document.getElementById('thankYouModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeThankYouModal();
            }
        });
    </script>
</body>
</html>